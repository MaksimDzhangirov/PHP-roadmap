[Оригинал](https://roadmap.sh/best-practices/api-security)

# Рекомендации по защите API

Перечень рекомендаций по защите API с пояснениями

## Аутентификация

### Избегайте «базовой аутентификации» ('Basic Authentication'), используйте стандарты (например, JWT)

> Cледует избегать использования «базовой аутентификации» и использовать любые другие стандартные методы аутентификации, например OAuth, JWT и т. д.

Базовая аутентификация – это простой метод аутентификации пользователя путем передачи учетных данных пользователя в виде обычного текста по сети. Этот метод по своей сути небезопасен, и его следует избегать, когда это возможно.

Существует несколько причин, по которым следует избегать базовой аутентификации и заменять ее более безопасными методами аутентификации:

* Отсутствие конфиденциальности: базовая аутентификация передает учетные данные пользователя (имя пользователя и пароль) в виде обычного текста по сети. Это означает, что любой, кто перехватывает трафик, может легко считать учетные данные и получить доступ к учетной записи пользователя.

* Отсутствие целостности: базовая аутентификация не обеспечивает какого-либо механизма, гарантирующего, что передаваемые данные не были подделаны или изменены при передаче. Это означает, что злоумышленник может изменить трафик, чтобы получить доступ к учетной записи пользователя или выполнить другие вредоносные действия.

* Недостаточная надежность аутентификации: базовая аутентификация полагается исключительно на учетные данные пользователя для их аутентификации. Это означает, что если злоумышленнику удастся получить учетные данные пользователя (например, с помощью фишинга или социальной инженерии), он сможет легко получить доступ к учетной записи пользователя.

* Нет поддержки многофакторной аутентификации: базовая аутентификация не поддерживает многофакторную аутентификацию (MFA), которая является важным элементом безопасности и обеспечивает дополнительный уровень защиты от несанкционированного доступа.

И наоборот, другие методы аутентификации, такие как OAuth, OpenID Connect и SAML, предоставляют более безопасные и надежные методы аутентификации. Эти методы обычно используют зашифрованные протоколы для защиты учетных данных пользователя, предоставляют механизмы проверки целостности данных и поддерживают MFA. В результате они гораздо более безопасны и надежны, чем базовая аутентификация, и их следует использовать всегда, когда это возможно.

### Не изобретайте велосипед в механизмах аутентификации

> Используйте стандартные механизмы аутентификации для создания токенов, хранения учетных данных и аутентификации пользователей.

Вот несколько примеров устоявшихся механизмов аутентификации, которые вы можете использовать вместо того, чтобы изобретать велосипед:

* OAuth: OAuth – это широко используемый открытый стандарт авторизации, который позволяет пользователям предоставлять сторонним приложениям доступ к своим ресурсам, не передавая свои учетные данные. Он обычно используется веб-службами и API, чтобы пользователи могли входить в систему, используя свои учетные записи в социальных сетях или другие сторонние учетные записи.

* OpenID Connect: OpenID Connect – это протокол аутентификации, созданный на основе OAuth 2.0, который позволяет пользователям проходить аутентификацию на нескольких веб-сайтах и в приложениях, используя один набор учетных данных. Он обычно используется для единого входа (SSO) на нескольких веб-сайтах и в приложениях.

* SAML: **S**ecurity **A**ssertion **M**arkup **L**anguage (SAML, язык разметки декларации безопасности) – это стандарт на основе XML для обмена данными аутентификации и авторизации между сторонами. Он обычно используется для единого входа в нескольких доменах или организациях.

* Алгоритмы хеширования паролей: алгоритмы хеширования паролей, такие как `bcrypt` и `scrypt`, широко используются для безопасного хранения и защиты паролей пользователей. Эти алгоритмы гарантируют, что даже если злоумышленник получит доступ к базе данных паролей, он не сможет легко восстановить пароли.

* Двухфакторная аутентификация (2FA): 2FA – это механизм аутентификации, который требует от пользователей предоставления двух форм идентификации для доступа к своим учетным записям. Обычно это включает в себя что-то, что знает пользователь (например, пароль) и что-то, что у него есть (например, мобильное устройство или ключ безопасности). Многие сервисы и приложения теперь предлагают 2FA в качестве дополнительной меры безопасности.

### Используйте максимальное число неудачных попыток ('Max Retry') и функционал, осуществляющий блокировку, при определённом числе неудачных входов в систему

> Максимальное число неудачных попыток и блокировка часто используются в механизмах входа в систему для повышения безопасности и предотвращения атак методом «грубой силой»

**Максимальное число неудачных попыток**: Функционал «максимальное число неудачных попыток» ограничивает количество попыток входа в систему, которые пользователь может сделать в течение определенного периода времени. После определенного количества неудачных попыток входа в систему блокируется учетная запись пользователя на определенный период времени, обычно на несколько минут или часов. Это помогает предотвратить атаки методом «грубой силой», когда злоумышленник пытается угадать пароль пользователя, предпринимая повторные попытки входа в систему. Ограничивая количество попыток, система может замедлить или предотвратить такие атаки.

**Блокировка**: Функционал «блокировки» предполагает блокировку IP-адресов или учетных записей пользователей, у которых превышено максимальное количество неудачных попыток входа в систему в течение определенного периода времени. Заблокированным IP-адресам или учетным записям пользователей запрещается дальнейший вход в систему в течение определенного периода времени, обычно нескольких минут или часов. Это помогает предотвратить атаки методом «грубой силой», а также обеспечивает механизм, предотвращающий повторные попытки злоумышленников получить доступ к учетной записи или системе.

### Используйте шифрование для всех конфиденциальных данных

> Шифрование конфиденциальных данных важно для их защиты от несанкционированного доступа, кражи и использования.

Шифрование – это процесс преобразования простых текстовых данных в зашифрованный текст, который может быть расшифрован только тем, у кого есть ключ дешифрования. Это затрудняет злоумышленникам доступ к конфиденциальным данным, даже если они могут их перехватить или получить к ним несанкционированный доступ.

Для шифрования конфиденциальных данных вы можете использовать такие алгоритмы шифрования, как `AES` или `RSA`, а также надежную систему управления ключами, обеспечивающую безопасное хранение и управление ключами. Кроме того, вы можете реализовать другие меры безопасности, такие как контроль доступа, брандмауэры и системы обнаружения хакерских атак, для дальнейшей защиты конфиденциальных данных.

## JWT (JSON веб-токен)

### Используйте такой «JWT секретный ключ» ('JWT Secret'), который усложнит его подбор атакой методом «грубой силой» (полным перебором)

> Позаботьтесь о хорошем секретный ключе для JWT для защиты от внесения злонамеренных изменений в токен (подделки токена), а также для предотвращения атак методом «грубой силы».

Надёжный секретный ключ должен генерироваться случайным образом, быть длинным и сложным, храниться в надежном месте и периодически меняться.

### Не извлекайте алгоритм из заголовка запроса, используйте бэкенд

> Не извлекайте алгоритм из заголовка запроса, используйте бэкенд

Извлечение алгоритма из заголовка JWT токена может представлять угрозу безопасности, поскольку злоумышленник может изменить алгоритм и потенциально получить несанкционированный доступ. Поэтому рекомендуется проверять алгоритм, используя бэкенд, а не извлекать его из заголовка. Это поможет гарантировать, что алгоритм, используемый для подписи и проверки токена, безопасен и не был подделан.

### Делайте срок действия токена (TTL, RTTL) как можно короче

> Срок действия токена должен быть выбран в соответствии с требованиями к системе и не превышать объективно необходимый срок, чтобы уменьшить окно уязвимости системы, ограничить
> последствия кражи токенов и повысить общую безопасность.

Установка короткого срока действия токена (TTL, RTTL) важна в целях безопасности, поскольку уменьшает окно уязвимости, ограничивает влияние кражи токена и повышает общую безопасность. Однако срок действия должен быть сбалансирован с удобством использования, поскольку слишком короткий срок может доставить неудобства пользователям и снизить производительность.

### Избегайте хранения конфиденциальных данных в полезной нагрузке JWT

> Избегайте хранения конфиденциальных данных в полезной нагрузке JWT

Хранение конфиденциальных данных в полезной нагрузке JWT токена может увеличить риск утечки данных и других ситуаций, связанных с нарушением безопасности. Если злоумышленник сможет раздобыть или подделать токен, он потенциально может получить доступ к конфиденциальным данным, хранящимся в полезных данных.

### Старайтесь сделать полезную нагрузку небольшой, чтобы уменьшить размер JWT токена

> Избегайте хранения больших полезных нагрузок в JWT токенах

Небольшая полезная нагрузка может снизить накладные расходы при передаче по сети, повысить скорость обработки и снизить риск атак, направленных на перегрузку системы.

## Контроль доступа

### Ограничивайте число запросов (ограничение пропускной способности, throttling), чтобы избежать DDoS атак / атакой методом «грубой силой»
### Используйте HTTPS на стороне сервера и безопасные алгоритмы шифрования
### Используйте заголовок HSTS с SSL, чтобы избежать атак SSL Strip
### Отключите вывод списка каталогов
### Приватные API должны быть доступны только для «безопасного» списка IP-адресов

## OAuth

### Всегда проверяйте 'redirect_uri' на стороне сервера
### Не используйте 'response_type=token', а вместо него применяйте поток с кодом подтверждения
### Используйте параметр 'state' для предотвращения CSRF атак
### У вас должна быть «набор запрашиваемых у пользователя разрешений на доступ к данным» (scope) по умолчанию и необходимо проверять его для каждого приложения


## Обработка

### Проверьте для всех ли конечных точек с доступом только для аутентифицированных пользователей выполняется процесс аутентификации, чтобы избежать нарушения процесса аутентификации
### Избегайте использования идентификатора пользователя в URL-адресах ресурсов, например, `users/242/orders`
### Предпочитайте использовать UUID вместо автоинкрементных идентификаторов
### Отключите парсинг поступающих извне XML сущностей, если вы парсите XML, чтобы избежать XXE атак
### Отключите расширения, позволяющие обрабатывать поступающие извне сущности, если вы используете XML, YML или любой другой язык
### Используйте CDN для загрузки файлов
### Избегайте ситуаций, когда часть HTTP запросов не может быть выполнена из-за большого объёма данных
### Обязательно отключите режим отладки на продакшене
### Используйте Non-Executable Stacks, когда это возможно

## Обработка входных данных

### Используйте HTTP-метод, соответствующий осуществляемой операции
### Проверяйте `content-type` в заголовке запроса
### Проверяйте вводимые пользователем данные, чтобы избежать распространенных уязвимостей
### Используйте стандартный заголовок `Authorization` для конфиденциальных данных
### Используйте только шифрование на стороне сервера
### Используйте API шлюз для кэширования, правила, ограничивающие число запросов к ресурсу за определённый период времени и т. д.

## Обработка выходных данных

### Отправляйте заголовок `X-Content-Type-Options: nosniff`
### Отправляйте заголовок `X-Frame-Options: Deny`
### Отправляйте заголовок `Content-Security-Policy: default-src 'none'`
### Удалите заголовки, которые могут облегчить идентификацию сервера (например, `x-powered-by` и т. д.)
### Принудительно задавайте `content-type` для вашего ответа
### Избегайте передачи в ответе конфиденциальных данных (учетных данных, аутентификационных токенов и т. д.)
### Возвращайте правильные коды ответа в соответствии с операцией

## CI & CD

### Проверяйте программную архитектуру и реализацию с помощью unit/интеграционных тестов
### Используйте сode review (рецензирование кода, обзор кода, ревизия кода) и не полагайтесь только на себя
### Постоянно осуществляйте анализ безопасности вашего кода
### Проверьте свои зависимости на наличие известных уязвимостей
### Разработайте механизм для отката версии развёрнутой на продакшене

## Мониторинг

### Используйте централизованный доступ (логин) для всех служб и компонентов
### Используйте агентов для отслеживания всех запросов, ответов и ошибок
### Используйте оповещения, отравляемые через SMS, Slack, электронной почты, Kibana, Cloudwatch и т. д.
### Убедитесь, что вы не пишите в лог никакие конфиденциальные данные
### Используйте IDS и/или IPS систему для мониторинга всего необходимого

## Список рекомендованных ссылок по теме

* [Collection of Resources for Building APIs](https://github.com/yosriady/awesome-api-devtools)
* [CS253: Web Security](https://www.youtube.com/watch?v=5JJrJGZ_LjM&list=PL1y1iaEtjSYiiSGVlL1cHsXN_kvJOOhu-)
* [Securing Web Applications](https://www.youtube.com/watch?v=WlmKwIe9z1Q)
* [MIT 6.858: Computer Systems Security](https://www.youtube.com/watch?v=GqmQg-cszw4&list=PLUl4u3cNGP62K2DjQLRxDNRi0z2IRWnNh)
